"""
Template Engine for Resume PDF Generation
Manages resume templates and renders them to HTML for PDF generation
"""

from pathlib import Path
from typing import Dict, Any, Optional
from jinja2 import Environment, FileSystemLoader, Template
from io import BytesIO
from .cache_manager import cache_template, cache_pdf, generate_cache_key

# Try to import WeasyPrint, but make it optional
try:
    from weasyprint import HTML, CSS
    WEASYPRINT_AVAILABLE = True
except (ImportError, OSError) as e:
    WEASYPRINT_AVAILABLE = False
    WEASYPRINT_ERROR = str(e)
    print(f"⚠️  WeasyPrint not available: {e}")
    print("   PDF generation will be disabled. Content optimization will still work.")
    HTML = None
    CSS = None


class TemplateEngine:
    """Template engine for rendering resume templates"""
    
    def __init__(self, template_dir: Optional[Path] = None):
        """
        Initialize template engine
        
        Args:
            template_dir: Path to templates directory (defaults to app/templates)
        """
        if template_dir is None:
            template_dir = Path(__file__).parent / "templates"
        
        self.template_dir = template_dir
        self.template_dir.mkdir(exist_ok=True)
        
        # Initialize Jinja2 environment
        self.env = Environment(
            loader=FileSystemLoader(str(template_dir)),
            autoescape=True,
            trim_blocks=True,
            lstrip_blocks=True
        )
        
        # Load available templates
        self.templates = self._load_templates()
    
    def get_template(self, template_id: str) -> Dict[str, Any]:
        """
        Get template by ID
        
        Args:
            template_id: Template identifier
            
        Returns:
            Template dictionary with 'name', 'template', and 'css' keys
            
        Raises:
            ValueError: If template not found
        """
        if template_id not in self.templates:
            available = ', '.join(self.templates.keys())
            raise ValueError(
                f"Template '{template_id}' not found. "
                f"Available templates: {available}"
            )
        return self.templates[template_id]
    
    def render(self, template_id: str, resume_data: Dict[str, Any]) -> str:
        """
        Render resume to HTML (with caching)
        
        Args:
            template_id: Template identifier
            resume_data: Resume data dictionary
            
        Returns:
            Rendered HTML string
            
        Raises:
            ValueError: If template not found
        """
        # Generate cache key
        cache_key = f"render:{template_id}:{generate_cache_key(resume_data)}"
        
        # Try to get from cache
        from .cache_manager import cache_manager
        cached_html = cache_manager.get_template_cache().get(cache_key)
        if cached_html is not None:
            return cached_html
        
        # Render template
        template_info = self.get_template(template_id)
        template = template_info['template']
        html = template.render(resume=resume_data)
        
        # Cache the result
        cache_manager.get_template_cache().set(cache_key, html)
        
        return html
    
    def get_css(self, template_id: str) -> str:
        """
        Get CSS for a template
        
        Args:
            template_id: Template identifier
            
        Returns:
            CSS string
            
        Raises:
            ValueError: If template not found
        """
        template_info = self.get_template(template_id)
        return template_info['css']
    
    def list_templates(self) -> Dict[str, str]:
        """
        List available templates
        
        Returns:
            Dictionary mapping template IDs to names
        """
        return {
            template_id: info['name']
            for template_id, info in self.templates.items()
        }
    
    def generate_pdf(
        self, 
        template_id: str, 
        resume_data: Dict[str, Any],
        options: Optional[Dict[str, Any]] = None
    ) -> bytes:
        """
        Generate PDF from resume data using WeasyPrint (with caching)
        
        Args:
            template_id: Template identifier
            resume_data: Resume data dictionary
            options: Optional PDF generation options
            
        Returns:
            PDF file as bytes
            
        Raises:
            ValueError: If template not found
            Exception: If PDF generation fails or WeasyPrint not available
        """
        # Check if WeasyPrint is available
        if not WEASYPRINT_AVAILABLE:
            raise Exception(
                f"PDF generation is not available. WeasyPrint could not be loaded: {WEASYPRINT_ERROR}. "
                "Please install GTK3 dependencies. See backend/WEASYPRINT_SETUP.md for instructions."
            )
        
        # Get default options
        if options is None:
            options = {}
        
        # Generate cache key
        cache_key = f"pdf:{template_id}:{generate_cache_key(resume_data, options)}"
        
        # Try to get from cache
        from .cache_manager import cache_manager
        cached_pdf = cache_manager.get_pdf_cache().get(cache_key)
        if cached_pdf is not None:
            return cached_pdf
        
        # Render HTML (this will use template cache)
        html_content = self.render(template_id, resume_data)
        css_content = self.get_css(template_id)
        
        # Configure WeasyPrint settings for ATS compatibility
        # - No tables (templates already avoid tables)
        # - Proper text extraction
        # - Standard fonts
        # - Clear structure
        
        try:
            # Create HTML object
            html = HTML(string=html_content)
            
            # Create CSS object
            css = CSS(string=css_content)
            
            # Generate PDF with proper settings
            pdf_bytes = html.write_pdf(
                stylesheets=[css],
                # Optimize for text extraction (ATS compatibility)
                optimize_size=('fonts',),
                # Enable proper text rendering
                presentational_hints=True,
                # Set PDF metadata
                pdf_forms=False
            )
            
            # Cache the result
            cache_manager.get_pdf_cache().set(cache_key, pdf_bytes)
            
            return pdf_bytes
            
        except Exception as e:
            raise Exception(f"PDF generation failed: {str(e)}")
    
    def generate_pdf_to_file(
        self,
        template_id: str,
        resume_data: Dict[str, Any],
        output_path: Path,
        options: Optional[Dict[str, Any]] = None
    ) -> Path:
        """
        Generate PDF and save to file
        
        Args:
            template_id: Template identifier
            resume_data: Resume data dictionary
            output_path: Path to save PDF file
            options: Optional PDF generation options
            
        Returns:
            Path to generated PDF file
            
        Raises:
            ValueError: If template not found
            Exception: If PDF generation fails
        """
        pdf_bytes = self.generate_pdf(template_id, resume_data, options)
        
        # Ensure parent directory exists
        output_path.parent.mkdir(parents=True, exist_ok=True)
        
        # Write PDF to file
        output_path.write_bytes(pdf_bytes)
        
        return output_path
    
    def _load_templates(self) -> Dict[str, Dict[str, Any]]:
        """
        Load all available templates
        
        Returns:
            Dictionary of template information
        """
        templates = {}
        
        # Try to load each template
        template_configs = [
            ('professional', 'Professional'),
            ('modern', 'Modern'),
            ('minimal', 'Minimal')
        ]
        
        for template_id, template_name in template_configs:
            try:
                template = self.env.get_template(f'{template_id}.html')
                css = self._load_css(f'{template_id}.css')
                
                templates[template_id] = {
                    'name': template_name,
                    'template': template,
                    'css': css
                }
            except Exception as e:
                # Template not found or error loading - skip it
                print(f"Warning: Could not load template '{template_id}': {e}")
                continue
        
        # If no templates loaded, create a default one
        if not templates:
            templates['default'] = {
                'name': 'Default',
                'template': self._create_default_template(),
                'css': self._get_default_css()
            }
        
        return templates
    
    def _load_css(self, filename: str) -> str:
        """
        Load CSS file
        
        Args:
            filename: CSS filename
            
        Returns:
            CSS content as string
        """
        css_dir = self.template_dir / "css"
        css_path = css_dir / filename
        
        if css_path.exists():
            return css_path.read_text(encoding='utf-8')
        else:
            return self._get_default_css()
    
    def _create_default_template(self) -> Template:
        """
        Create a default template if none are available
        
        Returns:
            Jinja2 Template object
        """
        default_html = """<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Resume</title>
</head>
<body>
    <div class="resume">
        <h1>{{ resume.name or 'Resume' }}</h1>
        
        {% if resume.summary %}
        <section class="summary">
            <h2>Professional Summary</h2>
            <p>{{ resume.summary }}</p>
        </section>
        {% endif %}
        
        {% if resume.experience %}
        <section class="experience">
            <h2>Experience</h2>
            {% for job in resume.experience %}
            <div class="job">
                <h3>{{ job.title }} - {{ job.company }}</h3>
                <p class="dates">{{ job.dates }}</p>
                {% if job.location %}
                <p class="location">{{ job.location }}</p>
                {% endif %}
                <ul>
                {% for item in job.description %}
                    <li>{{ item }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </section>
        {% endif %}
        
        {% if resume.education %}
        <section class="education">
            <h2>Education</h2>
            {% for edu in resume.education %}
            <div class="education-item">
                <h3>{{ edu.degree }} - {{ edu.institution }}</h3>
                <p class="dates">{{ edu.dates }}</p>
            </div>
            {% endfor %}
        </section>
        {% endif %}
        
        {% if resume.skills %}
        <section class="skills">
            <h2>Skills</h2>
            <ul>
            {% for skill in resume.skills %}
                <li>{{ skill }}</li>
            {% endfor %}
            </ul>
        </section>
        {% endif %}
    </div>
</body>
</html>"""
        return self.env.from_string(default_html)
    
    def _get_default_css(self) -> str:
        """
        Get default CSS
        
        Returns:
            Default CSS string
        """
        return """
body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
    color: #333;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

h1 {
    font-size: 28px;
    margin-bottom: 10px;
    color: #2c3e50;
}

h2 {
    font-size: 20px;
    margin-top: 20px;
    margin-bottom: 10px;
    color: #34495e;
    border-bottom: 2px solid #3498db;
    padding-bottom: 5px;
}

h3 {
    font-size: 16px;
    margin-bottom: 5px;
    color: #2c3e50;
}

.dates {
    font-style: italic;
    color: #7f8c8d;
    margin: 5px 0;
}

.location {
    color: #7f8c8d;
    margin: 5px 0;
}

ul {
    margin: 10px 0;
    padding-left: 20px;
}

li {
    margin: 5px 0;
}

.job, .education-item {
    margin-bottom: 20px;
}

.summary p {
    text-align: justify;
}
"""


# Global template engine instance
template_engine = TemplateEngine()
